<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
      <style type="text/css" media="all">
        @import url('./css/maven-base.css');
        @import url('./css/maven-theme.css');
      </style>
      <link href="./css/prettify.css" type="text/css" rel="stylesheet" />
      <script type="text/javascript" src="./css/prettify.js"></script>
      <link rel="stylesheet" href="./css/print.css" type="text/css" media="print" />
      <link href="./css/tooltip.css" rel="stylesheet" type="text/css" />
      <link href="./css/specs2-user.css" type="text/css" rel="stylesheet" />

      <script type="text/javascript" src="./css/jquery.js"></script>
      <script type="text/javascript" src="./css/jquery.cookie.js"></script>
      <script type="text/javascript" src="./css/jquery.hotkeys.js"></script>
      <script type="text/javascript" src="./css/jquery.jstree.js"></script>
      <script type="text/javascript" src="./css/tooltip.js"></script>
      <script type="text/javascript" src="./js/specs2-user.js"></script>
      <script language="javascript">$.getScript("./js/specs2-user.js", initUserScript(document));</script>
      <script language="javascript">
      function init() {  prettyPrint(); };
      /* found on : http://www.tek-tips.com/faqs.cfm?fid=6620 */
      String.prototype.endsWith = function(str) { return (this.match(str+'$') == str) };
      function changeWidth(id,width) {  document.getElementById(id).style.width = width; };
      function changeMarginLeft(id, margin) { document.getElementById(id).style.marginLeft = margin; };
      function toggleImage(image) {
        if (image.src.endsWith('images/expanded.gif')) 
          image.src = image.src.replace('expanded', 'collapsed');
        else 
          image.src = image.src.replace('collapsed', 'expanded');
      };
      function showHide(id) {
        element = document.getElementById(id);
        element.style.display = (element.style.display == 'block')? 'none' : 'block';
      };
      function showHideByClass(name) {
        var elements = document.getElementsByClassName(name);
        for (i = 0; i < elements.length; i++) {
          elements[i].style.display = (elements[i].style.display == 'none') ? elements[i].style.display = '': 'none';
        }
      };
      function showByClass(name) {
        var elements = document.getElementsByClassName(name);
        for (i = 0; i < elements.length; i++) {
          elements[i].style.display = 'block';
        }
      };
      function hideByClass(name) {
        var elements = document.getElementsByClassName(name);
        for (i = 0; i < elements.length; i++) {
          elements[i].style.display = 'none';
        }
      };
      function showById(id) {
        document.getElementById(id).style.display = ''
      };
      function hideById(id) {
        document.getElementById(id).style.display = 'none'
      };
    </script>
      <script language="javascript">window.onload=init;</script>
      <!-- the tabber.js file must be loaded after the onload function has been set, in order to run the
           tabber code, then the init code -->
      <script type="text/javascript" src="./css/tabber.js"></script>
      <link rel="stylesheet" href="./css/tabber.css" type="text/css" media="screen" />
      <title>Basic usage patterns</title>
    </head><body><div class="colmask threecol">
            <div class="colmid">
              <div class="colleft">
                <div class="col1"><div id="central"><html><title>Basic usage patterns</title><a name="Basic+usage+patterns"><h2 specId="1110707200">Basic usage patterns</h2></a><status class="ok"><div style="display: show; text-indent:0px;"><p>Mongo Streams can be used in various ways. It is designed to inject actual dependency on collection as late as possible and provides<br />powerful DSL with combinator syntax to allow expressive, simple to use, readable functional way to interact with mongoDB.</p><p>Any operation on collection is implemented as <code class="prettyprint">ChannelResult[A]</code>. <code class="prettyprint">A</code> Type parameter may be either <code class="prettyprint">DBObject</code> (when querying documents from<br />the collection), or <code class="prettyprint">WriteResult</code> (when performing save, insert or update). Additional types depend on each operation on collection.</p><p>To start with mongo streams include the generic syntax import</p><p><code class="prettyprint">import scalaz.stream.mongodb.collectionSyntax._</code></p><p>this will add to scope required implicits for Mongo Streams DSL.</p><a name="Create+simple+Queries"><h3>Create simple Queries</h3></a><p>Now you can easily create simple queries. The basic directive to do so is findDocuments code:</p><p><code class="prettyprint">query(&quot;key1&quot; === &quot;123&quot;)</code></p><p>This will return <code class="prettyprint">Query</code> object that can be used to perfrom actual query on collection like below:.</p>
<pre><code class="prettyprint">def queryOnlyActive = query(&quot;active&quot; === true)

    val allActiveUsers = (users through queryOnlyActive).collect.run
</code></pre><p>Note you may apply process combinators on the query <em>BEFORE</em> the query is actually combined with connection:</p></div></status><status class="ok"><div style="display: show; text-indent:0px;"><pre><code class="prettyprint">def queryOnlyFirst50Active = query(&quot;active&quot; === true) |&gt; take(50)

    val first50ActiveUsers = (users through queryOnlyFirst50Active).collect.run
</code></pre><p>In example above we also piped (|&gt;) result to another process, which further transformed the information from mongoDB. This<br />essentially allows you to combine queries and build a library of your own queries that can be reused and then applied to collection<br />when necessary.</p><a name="Serializing+and+deserializing"><h3>Serializing and deserializing</h3></a><p>Standard output of query operation from streams mongo is DBObject from java mongo driver.</p></div></status><status class="ok"><div style="display: show; text-indent:0px;"><img src="./images/icon_pending_sml.gif" />Â Show the example with pickling once we will have picliking library for streams ready TODO<br /></div></status><status class="ok"><div style="display: show; text-indent:0px;"><a name="Updating+documents"><h3>Updating documents</h3></a><p>Essentially there are two types of update operations that can be performed against mongo collection.</p>
<ul>
  <li>Operations that are based on query to limit first documents that will be affected</li>
  <li>Operations that directly modify the collection</li>
</ul><a name="Query+based+updates"><h4>Query based updates</h4></a><p>Query based updates are equivalents of mongoDB's <em>findAndModify</em>, <em>findAndRemove</em> and <em>update</em> commands.</p><p>This sets in all documents with name == luke their ship property to falcon:</p><p><code class="prettyprint">query(&quot;name&quot; -&gt; &quot;luke&quot;) and update(&quot;ship&quot; := &quot;falcon&quot;)</code></p><p>This removes all documents with name == yoda from collection (equivalent to remove in mongoDB):</p><p><code class="prettyprint">query(&quot;name&quot; -&gt; &quot;yoda&quot;) and remove</code></p><p>This modifies first document with name == yoda from collection (equivalent to findAndModify in mongodDB). In contrast with<br />update you may receive the original of the document updated</p><p><code class="prettyprint">query(&quot;name&quot; -&gt; &quot;yoda&quot;) and updateOne(&quot;ship&quot; := None)</code><br /><code class="prettyprint">query(&quot;name&quot; -&gt; &quot;yoda&quot;) and updateOne(&quot;ship&quot; := None).returnNew(true)</code><br /><code class="prettyprint">query(&quot;name&quot; -&gt; &quot;yoda&quot;).sort(&quot;last&quot; Ascending) and updateOne(document)</code></p><p>This removes first document with name == yoda from collection (equivalent to findAndModify with remove == true in mongoDB. In contrast with<br />remove, you may receive the original document that was removed, if present.</p><p><code class="prettyprint">query(&quot;name&quot; -&gt; &quot;yoda&quot;) and removeOne</code><br /><code class="prettyprint">query(&quot;name&quot; -&gt; &quot;yoda&quot;).sort(&quot;last&quot; Ascending) and removeOne</code></p><a name="Inserting+documents"><h4>Inserting documents</h4></a><p>New documents may be inserted in the mongoDB collection with either save or insert.</p><p><code class="prettyprint">insert(document)</code><br /><code class="prettyprint">save(document).ensure(WriteConcern.REPLICA_ACKNOWLEDGED)</code></p><a name="Combining+actions+together"><h3>Combining actions together</h3></a><p>All the actions in Mongo Streams can be combined together via process combinators.</p><a name="For+comprehensions"><h4>For comprehensions</h4></a><p>Mongo streams actions are monads, therefor they can be used in for comprehensions. Code below demonstrates one of<br />the possible usages where we first query all skywalkers and then we lookup all friends of the skywalkers:</p>
<pre><code class="prettyprint">def findAllSkyWalkersWithFriends =
      for {
        skywalker &lt;- query(&quot;name&quot; -&gt; &quot;luke&quot;)
        friend &lt;- query(&quot;friendOf&quot; -&gt; skywalker.as[String](&quot;name&quot;))
      } yield (skywalker, friend)

    starWars through findAllSkyWalkersWithFriends
</code></pre><p>Now this is great if we only want to interact with mongo collections, but what if we want to query all skywalker's and then maybe read<br />their blogs from internet? We can still combine mongo stream with some process that fetches the blogs from the internet web site like shown below:</p>
<pre><code class="prettyprint">def findBlog(sw: DBObject): Process[Task, String] = ???

    def skyWalkersBlogs =
      query(&quot;name&quot; -&gt; &quot;luke&quot;).flatMapProcess(sw=&gt;
        findBlog(sw).map(blog =&gt; (sw,blog))
      )
    


    starWars through skyWalkersBlogs
</code></pre><p>Another example that you may often need is that you query data from one colection and with results you want to query other collection.<br />Of course, this can be also achieved (again, without knowing upfront on which mongo collections it will run):</p>
<pre><code class="prettyprint">def readFrom2(col1: DBCollection, col2: DBCollection): Process[Task, (DBObject, DBObject)] = {

      for {
        sw &lt;- col1 through query(&quot;name&quot; -&gt; &quot;luke&quot;)
        ship &lt;- col2 through query(&quot;ship&quot; -&gt; sw.getAs[String](&quot;like&quot;))
      } yield (sw, ship)

    }

    // then later somewhere in your code or in test
    (readFrom2(collA, collB)): Process[Task, (DBObject, DBObject)]
</code></pre><a name="Process+combinators"><h4>Process combinators</h4></a><p>Mongo Stream actions have similar combinators to the ones you will find on scalaz-stream processes. They allow you to reuse syntax from streams to<br />further combine the actions with processes and processes with actions</p></div></status><status class="ok"><div style="display: show; text-indent:0px;"><pre><code class="prettyprint">//queries first all lukes and then all chewaccas
    def lukeAndChewacca =
    query(&quot;name&quot; -&gt; &quot;luke&quot;) ++ query(&quot;name&quot; -&gt; &quot;chewacca&quot;)

    //saves all lukes to file
    def flatFileStore: Sink[Task, DBObject] = ???

    (starWars through lukeAndChewacca) to flatFileStore

    //or

    def exportLukeAndChewacca2File = lukeAndChewacca to flatFileStore

    starWars through exportLukeAndChewacca2File
</code></pre></div></status><status class="ok"><div style="display: show; text-indent:5px;"></div></status><status class="ok"><br /></status><table class="dataTable">
        <tr><th colSpan="2">Total for specification BasicUsageSpec</th></tr>
        <tr><td>Finished in</td><td class="info">4 ms</td></tr>
        <tr><td>Results</td><td class="success">1 example, 0 failure, 0 error, 1 pending</td></tr>
      </table></html></div></div>
                <div class="col2"><div id="leftcolumn"><div id="tree">
      <ul><li id="1110707200"><a href="scalaz.stream.mongodb.userguide.BasicUsageSpec.html#Basic+usage+patterns">Basic usage patterns</a>
            <ul><li id=""><a href="scalaz.stream.mongodb.userguide.BasicUsageSpec.html#Create+simple+Queries">Create simple Queries</a>
            
          </li><li id=""><a href="scalaz.stream.mongodb.userguide.BasicUsageSpec.html#Serializing+and+deserializing">Serializing and deserializing</a>
            
          </li><li id=""><a href="scalaz.stream.mongodb.userguide.BasicUsageSpec.html#Updating+documents">Updating documents</a>
            <ul><li id=""><a href="scalaz.stream.mongodb.userguide.BasicUsageSpec.html#Query+based+updates">Query based updates</a>
            
          </li><li id=""><a href="scalaz.stream.mongodb.userguide.BasicUsageSpec.html#Inserting+documents">Inserting documents</a>
            
          </li></ul>
          </li><li id=""><a href="scalaz.stream.mongodb.userguide.BasicUsageSpec.html#Combining+actions+together">Combining actions together</a>
            <ul><li id=""><a href="scalaz.stream.mongodb.userguide.BasicUsageSpec.html#For+comprehensions">For comprehensions</a>
            
          </li><li id=""><a href="scalaz.stream.mongodb.userguide.BasicUsageSpec.html#Process+combinators">Process combinators</a>
            
          </li></ul>
          </li></ul>
          </li></ul>
      <script>$(function () {  $('#tree').jstree({'core':{'initially_open':['1110707200','1110707200'], 'animation':200}, 'plugins':['themes', 'html_data']}); });</script>
    </div></div></div>
                <div class="col3"><div id="rightcolumn"></div></div>
              </div>
            </div>
          </div></body></html>